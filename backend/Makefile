# Backend Service Makefile
# Provides convenient shortcuts for development, testing, deployment, and CI/CD

.DEFAULT_GOAL := dev

# Declare all targets as phony (don't produce files)
.PHONY: help dev dev-docker build install clean-install ci-install \
	test test-run test-coverage \
	lint lint-fix format format-check type-check check fix \
	db-generate db-migrate db-push db-studio migrate reset-db \
	docker-up docker-down docker-logs docker-clean up down logs clean \
	generate-openapi env setup ci

#===========================================
# Help
#===========================================

help: ## Show this help message
	@echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
	@echo "  Backend Service - Available Commands"
	@echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
	@echo ""
	@echo "ğŸ“¦ Setup & Installation:"
	@echo "  setup              Setup complete dev environment (install + env + db)"
	@echo "  install            Install dependencies (npm install)"
	@echo "  clean-install      Remove node_modules and fresh install"
	@echo "  ci-install         Reproducible install for CI (npm ci)"
	@echo "  env                Copy .env.example to .env (if not exists)"
	@echo ""
	@echo "ğŸš€ Development:"
	@echo "  dev                Start development server (default)"
	@echo "  dev-docker         Start development server for Docker"
	@echo "  build              Build for production (lint + type-check + build)"
	@echo ""
	@echo "ğŸ§ª Testing:"
	@echo "  test               Run tests in watch mode"
	@echo "  test-run           Run tests once (for CI)"
	@echo "  test-coverage      Run tests with coverage report"
	@echo ""
	@echo "âœ¨ Code Quality:"
	@echo "  lint               Check for linting errors"
	@echo "  lint-fix           Fix linting errors automatically"
	@echo "  format             Format code with Prettier"
	@echo "  format-check       Check code formatting"
	@echo "  type-check         Run TypeScript type checking"
	@echo "  check              Run all checks (lint + type-check + format-check)"
	@echo "  fix                Fix all issues (lint-fix + format)"
	@echo ""
	@echo "ğŸ—„ï¸  Database (Drizzle ORM):"
	@echo "  db-generate        Generate migrations from schema"
	@echo "  db-migrate         Apply migrations to database"
	@echo "  db-push            Push schema directly to DB (dev only)"
	@echo "  db-studio          Open Drizzle Studio GUI"
	@echo "  migrate            Generate and apply migrations"
	@echo "  reset-db           Reset database (âš ï¸  destructive)"
	@echo ""
	@echo "ğŸ³ Docker:"
	@echo "  docker-up (up)     Start all Docker services"
	@echo "  docker-down (down) Stop all Docker services"
	@echo "  docker-logs (logs) Follow backend logs"
	@echo "  docker-clean       Stop services and remove volumes"
	@echo ""
	@echo "ğŸ”§ Utilities:"
	@echo "  generate-openapi   Generate OpenAPI spec from Zod schemas"
	@echo "  ci                 Run full CI pipeline"
	@echo ""
	@echo "ğŸ’¡ Tip: Run 'make' without arguments to start dev server"
	@echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

#===========================================
# Setup & Installation
#===========================================

install: ## Install dependencies
	@echo "ğŸ“¦ Installing dependencies..."
	npm install
	@echo "âœ… Dependencies installed"

clean-install: ## Remove node_modules and fresh install
	@echo "ğŸ§¹ Removing node_modules..."
	rm -rf node_modules package-lock.json
	@echo "ğŸ“¦ Fresh install..."
	npm install
	@echo "âœ… Clean install complete"

ci-install: ## Reproducible install for CI
	@echo "ğŸ“¦ Installing dependencies (CI mode)..."
	npm ci
	@echo "âœ… CI dependencies installed"

env: ## Copy .env.example to .env if not exists
	@if [ ! -f .env ]; then \
		cp .env.example .env; \
		echo "âœ… Created .env from .env.example"; \
		echo "âš ï¸  Please review and update .env with your values"; \
	else \
		echo "âœ… .env already exists"; \
	fi

setup: install env db-push ## Setup complete dev environment
	@echo "âœ… Setup complete! Run 'make dev' to start development"

#===========================================
# Development
#===========================================

dev: generate-openapi ## Start development server
	@echo "ğŸš€ Starting development server..."
	npm run dev

dev-docker: ## Start development server for Docker
	@echo "ğŸ³ Starting development server (Docker mode)..."
	npm run dev:docker

build: lint type-check generate-openapi ## Build for production
	@echo "ğŸ”¨ Building backend..."
	npm run build
	@echo "âœ… Build complete"

#===========================================
# Testing
#===========================================

test: ## Run tests in watch mode
	@echo "ğŸ§ª Running tests in watch mode..."
	npm run test

test-run: ## Run tests once (for CI)
	@echo "ğŸ§ª Running tests..."
	npm run test:run

test-coverage: ## Run tests with coverage report
	@echo "ğŸ§ª Running tests with coverage..."
	npm run test:coverage

#===========================================
# Code Quality
#===========================================

lint: ## Check for linting errors
	@echo "ğŸ” Checking for linting errors..."
	npm run lint

lint-fix: ## Fix linting errors automatically
	@echo "ğŸ”§ Fixing linting errors..."
	npm run lint:fix

format: ## Format code with Prettier
	@echo "âœ¨ Formatting code..."
	npm run format

format-check: ## Check code formatting
	@echo "ğŸ” Checking code formatting..."
	npm run format:check

type-check: ## Run TypeScript type checking
	@echo "ğŸ” Type checking..."
	npm run type-check

check: lint type-check format-check ## Run all checks
	@echo "âœ… All checks passed"

fix: lint-fix format ## Fix all issues
	@echo "âœ… All fixes applied"

#===========================================
# Database (Drizzle ORM)
#===========================================

db-generate: ## Generate migrations from schema
	@echo "ğŸ”„ Generating migrations..."
	npx drizzle-kit generate
	@echo "âœ… Migrations generated"

db-migrate: ## Apply migrations to database
	@echo "ğŸ”„ Applying migrations..."
	npx drizzle-kit migrate
	@echo "âœ… Migrations applied"

db-push: ## Push schema directly to DB (dev only)
	@echo "ğŸ”„ Pushing schema to database..."
	npx drizzle-kit push
	@echo "âœ… Schema pushed"

db-studio: ## Open Drizzle Studio GUI
	@echo "ğŸ¨ Opening Drizzle Studio..."
	npx drizzle-kit studio

migrate: db-generate db-migrate ## Generate and apply migrations
	@echo "âœ… Migration complete"

reset-db: ## Reset database (âš ï¸  destructive)
	@echo "âš ï¸  WARNING: This will delete all database data!"
	@echo -n "Continue? [y/N] " && read ans && [ $${ans:-N} = y ]
	@echo "ğŸ”„ Resetting database..."
	@if [ -f "../docker-compose.yml" ]; then \
		cd .. && docker-compose down postgres && docker-compose up -d postgres; \
		echo "â³ Waiting for database to be ready..."; \
		sleep 5; \
		cd backend && $(MAKE) db-push; \
		echo "âœ… Database reset complete (via Docker)"; \
	else \
		echo "âŒ docker-compose.yml not found in parent directory"; \
		echo "ğŸ’¡ For local database reset, use manual SQL or Docker"; \
		exit 1; \
	fi

#===========================================
# Docker
#===========================================

docker-up: ## Start all Docker services
	@echo "ğŸ³ Starting Docker services..."
	cd .. && docker-compose up -d
	@echo "âœ… Docker services started"

docker-down: ## Stop all Docker services
	@echo "ğŸ³ Stopping Docker services..."
	cd .. && docker-compose down
	@echo "âœ… Docker services stopped"

docker-logs: ## Follow backend logs
	@echo "ğŸ“‹ Following backend logs (Ctrl+C to exit)..."
	cd .. && docker-compose logs -f backend

docker-clean: ## Stop services and remove volumes
	@echo "ğŸ§¹ Stopping services and removing volumes..."
	cd .. && docker-compose down -v
	@echo "âœ… Docker cleanup complete"

# Shortcut aliases for Docker commands
up: docker-up
down: docker-down
logs: docker-logs
clean: docker-clean

#===========================================
# Utilities
#===========================================

generate-openapi: ## Generate OpenAPI spec from Zod schemas
	@echo "ğŸ“„ Generating OpenAPI spec..."
	npm run generate:openapi
	@echo "âœ… OpenAPI spec generated"

ci: lint type-check test-run build ## Run full CI pipeline
	@echo "âœ… CI pipeline completed successfully"
