# FCIS Design Document

**Task**: Implement handleGetTransactionHistory TODO
**Created**: 2025-11-07 16:22:37
**Status**: Phase 1 - Analysis Complete

---

## Task Description

Implement the `handleGetTransactionHistory` endpoint that is currently a placeholder. This endpoint should retrieve transaction history for a specific user, with pagination support (limit and offset).

---

## Phase 1: Analysis

### Existing Domains Analyzed
- ‚úÖ users (authentication, user management)
- ‚úÖ wallets (multi-currency wallets)
- ‚úÖ transactions (coin transfers between users)
- ‚úÖ currencies (supported currency types)

### Primary Domain: **transactions**

The task will extend the existing `transactions` domain.

### Pattern Analysis

**Naming Conventions**:
- Files: kebab-case (e.g., `get-user-wallets.workflow.ts`, `transfer-coins.operations.ts`)
- Functions: camelCase, verb-first (e.g., `getUserWallets`, `findAllUserWallets`, `validateGetUserWallets`)
- Types: PascalCase with descriptive suffixes (e.g., `GetTransactionHistoryInput`, `TransactionData`)
- Error codes: DOMAIN_SPECIFIC_ERROR format (e.g., `TRANSACTION_WALLET_NOT_FOUND`)

**File Structure**:
- One workflow per file (`*.workflow.ts`)
- Operations grouped by feature (`*.operations.ts`)
- Types organized in `/types` directory:
  - `inputs.ts`: External request data
  - `outputs.ts`: External response data
  - `errors.ts`: Domain-specific errors
  - `internal.ts`: Implementation-only types
- Value objects in `/value-objects` directory

**Common Workflow Pattern**:
```typescript
export function workflowName(input: InputType): Result<OutputType> {
  return pipe(
    validateInput(input),
    performOperation,
    formatOutput
  );
}
```

**Repository Pattern**:
- Factory functions for dependency injection
- Methods return `Promise<Entity[]>`
- Pagination support with `limit` and `offset` parameters
- `withTransaction()` for transaction support

### Existing Infrastructure

**TransactionRepository** (already exists):
- ‚úÖ `findByWalletId(walletId, limit, offset)`: Finds all transactions for a wallet
- ‚úÖ `countByWalletId(walletId)`: Counts transactions for a wallet
- ‚úÖ `findSentByWalletId()`: Finds sent transactions
- ‚úÖ `findReceivedByWalletId()`: Finds received transactions

**WalletRepository** (already exists):
- ‚úÖ `findAllByUserId(userId)`: Gets all user wallets

**Existing Types**:
- ‚úÖ `GetTransactionHistoryInput` already defined in `types/inputs.ts`
- ‚úÖ `GetTransactionHistoryResult` already defined in `types/outputs.ts`
- ‚úÖ `TransactionData` type already defined

### Required Components

**New Files**:
1. `src/core/transactions/get-transaction-history.operations.ts` - Business logic operations
2. `src/core/transactions/get-transaction-history.workflow.ts` - Workflow orchestration

**Modified Files**:
1. `src/core/transactions/index.ts` - Add new workflow export
2. `src/routes/transactions/handlers.ts` - Implement real handler (replace placeholder)

**No Changes Needed**:
- ‚ùå Database schema (transactions table exists)
- ‚ùå Repository (methods already exist)
- ‚ùå Types (already defined)
- ‚ùå Value objects (none needed)
- ‚ùå HTTP schemas (already defined in routes)
- ‚ùå OpenAPI (placeholder route already registered)

### Analysis Complete ‚úÖ

**Status**: ‚úÖ Approved by Developer

---

## Phase 2: Design

### Workflow Design

**File**: `src/core/transactions/get-transaction-history.workflow.ts`

**Purpose**: Orchestrate the retrieval of transaction history for a user with pagination.

**FCIS Principle**: This is part of the **Functional Core** - pure orchestration of operations using railway-oriented programming with `pipe()`.

**Workflow Steps**:
1. Validate input (userId, limit, offset)
2. Find all user's wallets
3. Find transactions for all wallets
4. Format and return results with total count

**Signature**:
```typescript
export function getTransactionHistory(
  input: GetTransactionHistoryInput
): Result<GetTransactionHistoryResult>
```

**Pattern**: Follow `getUserWallets` pattern - simple pipe composition.

---

### Operations Design

**File**: `src/core/transactions/get-transaction-history.operations.ts`

**Operations Needed**:

#### 1. `validateGetTransactionHistory`
- **Type**: Pure validation (no side effects)
- **Purpose**: Validate userId exists, set defaults for limit/offset
- **Returns**: `Result<GetTransactionHistoryInput>`
- **Defaults**: `limit = 10`, `offset = 0`

#### 2. `findUserWallets`
- **Type**: Side effect (database query) - uses `command()`
- **Purpose**: Find all wallets belonging to the user
- **Repository**: `walletRepository.findAllByUserId(userId)`
- **Returns**: `Result<{ userId: string; walletIds: string[] }>`
- **Error**: Fail if no wallets found (user has no wallets)

#### 3. `findTransactionsForWallets`
- **Type**: Side effect (database query) - uses `command()`
- **Purpose**: Find transactions for all user wallets with pagination
- **Repository**: Loop through walletIds, call `transactionRepository.findByWalletId()` for each
- **Aggregation**: Combine results, sort by `createdAt` DESC, apply pagination
- **Count**: Use `transactionRepository.countByWalletId()` for total
- **Returns**: `Result<{ transactions: Transaction[]; total: number }>`

#### 4. `formatTransactionHistory`
- **Type**: Pure transformation (no side effects)
- **Purpose**: Convert Transaction[] to TransactionData[], apply GetTransactionHistoryResult format
- **Returns**: `Result<GetTransactionHistoryResult>`

---

### Business Logic Design

**Workflow Composition** (Railway-Oriented Programming):
```typescript
export function getTransactionHistory(
  input: GetTransactionHistoryInput
): Result<GetTransactionHistoryResult> {
  return pipe(
    validateGetTransactionHistory(input),
    findUserWallets,
    findTransactionsForWallets,
    formatTransactionHistory
  );
}
```

**Error Handling**:
- `VALIDATION_ERROR`: Invalid userId or pagination parameters
- `WALLET_NOT_FOUND`: User has no wallets
- `INTERNAL_ERROR`: Database query failures

---

### Data Flow

```
HTTP Request
  ‚Üì
Handler (Imperative Shell)
  ‚Üì
getTransactionHistory workflow (Functional Core)
  ‚Üì
validateGetTransactionHistory ‚Üí success({ userId, limit, offset })
  ‚Üì
findUserWallets ‚Üí command() wraps DB query ‚Üí success({ userId, walletIds })
  ‚Üì
findTransactionsForWallets ‚Üí command() wraps DB queries ‚Üí success({ transactions, total })
  ‚Üì
formatTransactionHistory ‚Üí pure function ‚Üí success(GetTransactionHistoryResult)
  ‚Üì
Handler (matchResponse) ‚Üí HTTP Response
```

---

### Barrel Export Update

**File**: `src/core/transactions/index.ts`

**Add**:
```typescript
// Workflows
export { getTransactionHistory } from "./get-transaction-history.workflow";
```

---

### Handler Update

**File**: `src/routes/transactions/handlers.ts`

**Replace placeholder with**:
```typescript
export async function handleGetTransactionHistory(
  req: ValidatedRequest<{
    params: GetTransactionHistoryParams;
    query: GetTransactionHistoryQuery;
  }>
): Promise<AppResponse<GetTransactionHistoryResult>> {
  const { userId } = req.validated.params;
  const { limit, offset } = req.validated.query;

  const result = await run(getTransactionHistory({ userId, limit, offset }));

  return matchResponse(result, {
    onSuccess: (data) => createSuccessResponse(data),
    onFailure: (error) => createFailureResponse(error),
  });
}
```

---

### Design Complete ‚úÖ

**Summary**:
- 2 new files to create (workflow + operations)
- 2 files to modify (barrel export + handler)
- Following FCIS principles strictly
- Using existing infrastructure (repositories, types)
- Railway-oriented programming with `pipe()`
- Side effects wrapped in `command()`

**Status**: ‚úÖ Approved by Developer

---

## Phase 3: Planning

### File Inventory

#### Files to CREATE:
1. ‚ú® `src/core/transactions/get-transaction-history.workflow.ts`
   - Workflow orchestration
   - ~30 lines

2. ‚ú® `src/core/transactions/get-transaction-history.operations.ts`
   - 4 operations (validate, find wallets, find transactions, format)
   - ~150 lines

#### Files to MODIFY:
3. ‚úèÔ∏è `src/core/transactions/index.ts`
   - ADD: export getTransactionHistory workflow
   - ADD: (ensure GetTransactionHistoryInput/Result are exported - check first)
   - Conflict: None (barrel export append)

4. ‚úèÔ∏è `src/routes/transactions/handlers.ts`
   - REPLACE: handleGetTransactionHistory placeholder
   - ADD: Import getTransactionHistory from barrel
   - ADD: Import ValidatedRequest, GetTransactionHistoryParams/Query types
   - Conflict: None (replacing TODO placeholder)

---

### Pre-Generation Validation

#### Feasibility Check ‚úÖ
- ‚úÖ All required repositories exist
- ‚úÖ All required types exist
- ‚úÖ HTTP routes already defined
- ‚úÖ No database migrations needed
- ‚úÖ No new dependencies needed

#### Naming Convention Check ‚úÖ
- ‚úÖ Files: kebab-case (`get-transaction-history.*.ts`)
- ‚úÖ Functions: camelCase (`getTransactionHistory`, `findUserWallets`)
- ‚úÖ Follows existing pattern from `transfer-coins.*` files

#### FCIS Compliance Check ‚úÖ
- ‚úÖ Workflow in Functional Core (pure orchestration)
- ‚úÖ Operations separated (validation vs side effects)
- ‚úÖ Side effects wrapped in `command()`
- ‚úÖ Uses `pipe()` for composition
- ‚úÖ Barrel export for public API
- ‚úÖ Handler in Imperative Shell

#### Dependency Check ‚úÖ
- ‚úÖ `walletRepository` - exists in #infrastructure/repositories/drizzle
- ‚úÖ `transactionRepository` - exists in #infrastructure/repositories/drizzle
- ‚úÖ `Result`, `command`, `pipe`, `success`, `fail` - exist in #lib/result
- ‚úÖ `run`, `matchResponse` - exist in #lib/result
- ‚úÖ Types already defined in transactions domain

---

### Execution Plan

Since this is a simple extension with no new infrastructure, we'll skip most specialists and execute directly:

#### Specialists to SKIP (not needed):
- ‚ùå schema-designer: No database changes
- ‚ùå repository-builder: Repositories exist
- ‚ùå external-service-builder: No external services
- ‚ùå value-object-creator: No value objects needed
- ‚ùå openapi-registrar: Route already registered
- ‚ùå test-generator: Can be done later (not blocking)

#### Specialists to EXECUTE:
1. **operations-builder** (Manual)
   - Create `get-transaction-history.operations.ts`
   - 4 operations following FCIS patterns

2. **workflow-composer** (Manual)
   - Create `get-transaction-history.workflow.ts`
   - Use pipe() composition

3. **route-generator** (Manual)
   - Update barrel export
   - Update handler

4. **validator** (Manual)
   - Run type-check
   - Run lint
   - Verify barrel exports
   - Verify FCIS compliance

---

### Merge Strategy

All changes are additive or replacement of placeholders:
- ‚úÖ New files: No conflicts
- ‚úÖ Barrel export: Append to existing exports
- ‚úÖ Handler: Replace TODO placeholder function

---

### Planning Complete ‚úÖ

**Execution Approach**: Manual implementation (simple enough, no need for Task agents)

**Estimated Time**: 5-10 minutes

**Risk Level**: Low (extending existing patterns)

**Status**: ‚úÖ Approved by Developer

---

## Phase 4: Implementation

### Files Created

#### 1. ‚ú® `src/core/transactions/get-transaction-history.operations.ts` (Created)

**Operations Implemented**:
- `validateGetTransactionHistory`: Sets defaults (limit=10, offset=0)
- `findUserWallets`: Finds all wallets for user with `command()`
- `findTransactionsForWallets`: Aggregates transactions from all wallets with pagination
- `formatTransactionHistory`: Pure transformation to API format

**FCIS Principles Applied**:
- ‚úÖ Side effects wrapped in `command()` with observability
- ‚úÖ Pure functions for validation and formatting
- ‚úÖ Proper error handling with domain-specific error codes
- ‚úÖ Type-safe Result returns

#### 2. ‚ú® `src/core/transactions/get-transaction-history.workflow.ts` (Created)

**Workflow Implementation**:
```typescript
export function getTransactionHistory(
  input: GetTransactionHistoryInput
): Result<GetTransactionHistoryResult> {
  return pipe(
    validateGetTransactionHistory(input),
    findUserWallets,
    findTransactionsForWallets,
    formatTransactionHistory
  );
}
```

**FCIS Principles Applied**:
- ‚úÖ Railway-oriented programming with `pipe()`
- ‚úÖ Pure orchestration (no side effects in workflow)
- ‚úÖ Automatic error propagation
- ‚úÖ Clear documentation with examples

#### 3. ‚úèÔ∏è `src/core/transactions/index.ts` (Modified)

**Changes**:
- Added: `export { getTransactionHistory } from "./get-transaction-history.workflow";`
- Types already exported (GetTransactionHistoryInput, GetTransactionHistoryResult)

**FCIS Principles Applied**:
- ‚úÖ Barrel export maintains public API boundary
- ‚úÖ Only workflow exposed, operations remain internal

#### 4. ‚úèÔ∏è `src/routes/transactions/handlers.ts` (Modified)

**Changes**:
- Replaced placeholder `handleGetTransactionHistory` with full implementation
- Added imports: `getTransactionHistory`, `GetTransactionHistoryParams`, `GetTransactionHistoryQuery`
- Handler now uses `run()` and `matchResponse()` pattern

**FCIS Principles Applied**:
- ‚úÖ Handler in Imperative Shell (HTTP concerns)
- ‚úÖ Imports workflow from barrel export only
- ‚úÖ Proper Result execution with `run()`
- ‚úÖ Type-safe response handling

---

### Validation Results

#### Type Check ‚úÖ
```bash
$ npm run type-check
‚úÖ No TypeScript errors
```

#### Lint Check ‚úÖ
```bash
$ npm run lint
‚úÖ No ESLint errors
```

#### FCIS Compliance ‚úÖ
- ‚úÖ Functional Core: Pure workflow orchestration
- ‚úÖ Imperative Shell: Side effects in operations, HTTP in handlers
- ‚úÖ Railway-Oriented Programming: `pipe()` composition
- ‚úÖ Command Pattern: Side effects wrapped with observability
- ‚úÖ Barrel Exports: Public API properly encapsulated
- ‚úÖ Repository Pattern: Using existing factory functions
- ‚úÖ Type Safety: All types properly defined and used

---

### FCIS Educational Notes

**What We Built**:

1. **Workflow (Functional Core)**:
   - Pure orchestration using `pipe()` for railway-oriented programming
   - Each step receives previous step's output automatically
   - If any step fails, execution stops and error propagates
   - No side effects - just composition of operations

2. **Operations (Mixed)**:
   - `validateGetTransactionHistory`: Pure function (no side effects)
   - `findUserWallets`: Side effect wrapped in `command()` for observability
   - `findTransactionsForWallets`: Complex side effect with parallel DB queries
   - `formatTransactionHistory`: Pure transformation function

3. **Command Pattern**:
   - Wraps async database operations
   - Automatically adds OpenTelemetry spans
   - Records Prometheus metrics
   - Provides Pino logging with correlation IDs
   - Makes side effects explicit and observable

4. **Barrel Exports**:
   - Only workflow exported in `index.ts`
   - Operations remain internal (implementation detail)
   - Types exported for handler use
   - Maintains clean architectural boundaries

5. **Handler (Imperative Shell)**:
   - Lives in HTTP layer (outside core)
   - Imports workflow from barrel export ONLY
   - Uses `run()` to execute Result
   - Uses `matchResponse()` for response formatting
   - No business logic - just HTTP concerns

---

### Implementation Complete ‚úÖ

**Summary**:
- ‚úÖ 2 files created (operations + workflow)
- ‚úÖ 2 files modified (barrel + handler)
- ‚úÖ All type checks pass
- ‚úÖ All lint checks pass
- ‚úÖ FCIS compliance verified
- ‚úÖ Follows existing patterns exactly

**Status**: ‚úÖ Iteration Applied

---

## Phase 5: Iteration

### Iteration 1: Use Paginated Response Helper

**Feedback**: "should be createPaginatedSuccessResponse in the handler!"

**Changes Made**:
1. Updated `src/routes/transactions/handlers.ts`:
   - Changed from `createSuccessResponse` to `createPaginatedSuccessResponse`
   - Converts offset/limit to page-based pagination format
   - Calculates page number: `Math.floor(offset / limit) + 1`
   - Includes pagination metadata in response

**Implementation**:
```typescript
return createPaginatedSuccessResponse(
  {
    transactions: data.transactions,
    total: data.total,
  },
  {
    page: Math.floor(actualOffset / actualLimit) + 1,
    size: actualLimit,
    total: data.total,
  }
);
```

**Validation**:
- ‚úÖ Type check passes
- ‚úÖ Lint passes
- ‚úÖ Proper pagination metadata in response

---

### Final Status

**Implementation Complete** ‚úÖ

**All Checks Passed**:
- ‚úÖ TypeScript compilation
- ‚úÖ ESLint validation
- ‚úÖ FCIS architectural compliance
- ‚úÖ Pagination response format

**Files Created/Modified**:
- ‚ú® Created: `get-transaction-history.operations.ts` (4 operations)
- ‚ú® Created: `get-transaction-history.workflow.ts` (workflow composition)
- ‚úèÔ∏è Modified: `transactions/index.ts` (barrel export)
- ‚úèÔ∏è Modified: `transactions/handlers.ts` (handler implementation)

**Ready for Production** üöÄ

