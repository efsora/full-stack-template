# FCIS Implementation Design

**Task**: User should determine which coin to send to User2 in his wallet for transactions
**Domain**: transactions
**Created**: 2025-11-07-15-32-33
**Status**: analysis

---

## Analysis

**Primary Domain**: transactions (existing), wallets (existing)
**Existing Domains**: Yes - Both transactions and wallets domains exist

### Current State Analysis

**Database Schema** (from `src/db/schema.ts`):
- **wallets** table: id, userId (unique), balance (numeric), createdAt, updatedAt
- **transactions** table: id, fromWalletId, toWalletId, amount (numeric), status, createdAt, updatedAt
- Recent migration (0003): Added `coin_type` column to both tables with default 'USD'
- Issue: Schema has coin_type but it's not being used in the application layer

**Existing Domains**:
1. **users** domain: Fully implemented with workflows, operations, value objects (Email, Password)
2. **wallets** domain: Partially implemented (get-user-wallets.workflow.ts, operations, types, NO value objects)
3. **transactions** domain: Only type definitions exist (inputs, outputs, internal) - NO workflows, operations, or value objects

**Pattern Analysis**:

**Naming Conventions**:
- Files: kebab-case (create-user.workflow.ts, get-wallet.operations.ts)
- Functions: camelCase, verb-first (createUser, getUserById, findByUserId)
- Types: PascalCase with suffixes (CreateUserInput, UserData, UserNotFoundError)
- Error codes: DOMAIN_ERROR_TYPE format (USER_NOT_FOUND, WALLET_ALREADY_EXISTS, WALLET_INSUFFICIENT_BALANCE)

**File Structure**:
- One workflow per file (create-user.workflow.ts, get-user.workflow.ts)
- Operations grouped by feature (create-user.operations.ts, find.operations.ts)
- Types organized in types/ directory (inputs.ts, outputs.ts, errors.ts, internal.ts)
- Value objects in value-objects/ directory
- Barrel export (index.ts) for public API

**Common Workflows**:
- CRUD patterns: create, get/find
- Use pipe() for composition
- Steps: validate → check business rules → save/fetch → transform result

**Error Handling**:
- Domain-prefixed error codes (USER_, WALLET_, expected: TRANSACTION_)
- Each error type extends ErrorBase
- Union type for all domain errors (UserError, WalletError)

**Value Objects**:
- users domain: Email, Password (branded types with validation)
- wallets domain: NONE (missing WalletBalance, CoinType)
- transactions domain: NONE (missing TransactionAmount, CoinType)

**Repository Pattern**:
- Factory functions: createUserRepository(dbInstance), createWalletRepository(dbInstance)
- Methods: create, findById, findByUserId, update, delete
- withTransaction support for all repositories
- Export singleton instance and type

### Task Interpretation

**Task**: "User should determine which coin to send to User2 in his wallet for transactions"

**Analysis**:
The task requires implementing multi-currency wallet support where:
1. Users can have multiple wallets (one per coin type: USD, EUR, BTC, etc.)
2. When creating a transaction, the sender specifies which coin type to send
3. Wallets are uniquely identified by (userId, coinType) instead of just userId
4. Transactions store the coin type they were executed in

**Current Gap**:
- Database has `coin_type` column but it's not exposed in the application
- Wallets are still treated as one-per-user (unique constraint on userId was removed but logic not updated)
- No transaction creation workflow exists
- No value objects for CoinType, TransactionAmount, WalletBalance

**Required Components**:

**Database**:
- ✅ coin_type column exists in wallets and transactions
- ❌ Need to add unique constraint on (userId, coinType) for wallets
- ❌ Need to add indexes for coin_type queries

**Value Objects**:
- CoinType (validate supported currencies: USD, EUR, BTC, ETH)
- TransactionAmount (validate positive, precision)
- WalletBalance (validate non-negative, precision)

**Workflows**:
- transferCoins (orchestrate transfer between two wallets of same coin type)
- getTransactionHistory (retrieve user's transaction history)
- createWallet (needs coin_type parameter)

**Operations**:
- validateTransferInput
- validateSameCoinType
- checkSufficientBalance
- deductFromWallet
- addToWallet
- createTransactionRecord
- findWalletsByUserIdAndCoinType
- findTransactionsByUserId

**Repository Updates**:
- WalletRepository: Update findByUserId to findByUserIdAndCoinType
- WalletRepository: Add findAllByUserId for multi-wallet support
- TransactionRepository: Implement create, findByWalletId, findByUserId

**Types**:
- TransferCoinsInput: { fromUserId, toUserId, amount, coinType }
- CreateWalletInput: needs coinType field
- Transaction error types: TRANSACTION_INSUFFICIENT_BALANCE, TRANSACTION_COIN_TYPE_MISMATCH, etc.

**Routes**:
- POST /api/v1/transactions/transfer (transfer coins)
- GET /api/v1/transactions/history/:userId (get history)
- POST /api/v1/wallets (create wallet - update to include coinType)
- GET /api/v1/wallets/:userId (get all wallets for user)

**External Services**: None required

**Tests**:
- CoinType value object validation
- TransactionAmount value object validation
- WalletBalance value object validation
- transferCoins workflow integration test

**Status**: ✅ Complete

---

## Design

### Database Schema

**Add currencies table** (src/db/schema.ts - NEW):
```typescript
/**
 * Currencies Table
 * Stores supported currency/coin types with metadata
 */
export const currencies = pgTable("currencies", {
  code: text("code").primaryKey(), // USD, EUR, BTC, ETH
  name: text("name").notNull(), // US Dollar, Euro, Bitcoin, Ethereum
  symbol: text("symbol").notNull(), // $, €, ₿, Ξ
  type: text("type").notNull(), // fiat, crypto
  isActive: boolean("is_active").notNull().default(true),
  createdAt: timestamp("created_at").defaultNow().notNull(),
  updatedAt: timestamp("updated_at").defaultNow().notNull().$onUpdate(() => new Date()),
});

export type Currency = typeof currencies.$inferSelect;
export type NewCurrency = typeof currencies.$inferInsert;
```

**Update wallets table** (src/db/schema.ts):
```typescript
export const wallets = pgTable(
  "wallets",
  {
    id: uuid("id").primaryKey().default(sql`uuidv7()`),
    userId: uuid("user_id").notNull().references(() => users.id, { onDelete: "cascade" }),
    coinType: text("coin_type").notNull().references(() => currencies.code, { onDelete: "restrict" }),
    balance: numeric("balance", { precision: 20, scale: 2 }).notNull().default("0.00"),
    createdAt: timestamp("created_at").defaultNow().notNull(),
    updatedAt: timestamp("updated_at").defaultNow().notNull().$onUpdate(() => new Date()),
  },
  (table) => [
    {
      // One wallet per user per coin type
      userCoinIdx: uniqueIndex("idx_wallets_user_coin").on(table.userId, table.coinType),
      coinTypeIdx: index("idx_wallets_coin_type").on(table.coinType),
      balanceIdx: index("idx_wallets_balance").on(table.balance),
    },
  ],
);
```

**Update transactions table** (src/db/schema.ts):
```typescript
export const transactions = pgTable(
  "transactions",
  {
    id: uuid("id").primaryKey().default(sql`uuidv7()`),
    fromWalletId: uuid("from_wallet_id").notNull().references(() => wallets.id, { onDelete: "restrict" }),
    toWalletId: uuid("to_wallet_id").notNull().references(() => wallets.id, { onDelete: "restrict" }),
    amount: numeric("amount", { precision: 20, scale: 2 }).notNull(),
    coinType: text("coin_type").notNull().references(() => currencies.code, { onDelete: "restrict" }),
    status: text("status").notNull().default("completed"),
    createdAt: timestamp("created_at").defaultNow().notNull(),
    updatedAt: timestamp("updated_at").defaultNow().notNull().$onUpdate(() => new Date()),
  },
  (table) => [
    {
      fromWalletIdx: index("idx_transactions_from_wallet").on(table.fromWalletId),
      toWalletIdx: index("idx_transactions_to_wallet").on(table.toWalletId),
      createdAtIdx: index("idx_transactions_created_at").on(table.createdAt),
      coinTypeIdx: index("idx_transactions_coin_type").on(table.coinType),
    },
  ],
);
```

**Migration Steps**:
1. Create currencies table with initial data (USD, EUR, BTC, ETH)
2. Add foreign key from wallets.coin_type to currencies.code
3. Add foreign key from transactions.coin_type to currencies.code
4. Add unique constraint on wallets(userId, coinType)
5. Rebuild indexes

### Type System

**Value Objects** (3 new value objects):

1. **CoinType** (src/core/wallets/value-objects/CoinType.ts):
   - Branded type: `type CoinType = string & { readonly __brand: unique symbol }`
   - Validation: Check if code exists in currencies table and isActive = true
   - Methods: create(value) -> async Result<CoinType>, toString(coinType), isEqual(a, b)
   - Error: WALLET_INVALID_COIN_TYPE (if currency doesn't exist or is not active)
   - Note: Async validation to check against database

2. **WalletBalance** (src/core/wallets/value-objects/WalletBalance.ts):
   - Branded type: `type WalletBalance = string & { readonly __brand: unique symbol }`
   - Validation: non-negative, max precision 20.2
   - Methods: create(value), add(a, b), subtract(a, b), isGreaterThanOrEqual(a, b), toString(balance), toNumber(balance)
   - Error: WALLET_INVALID_BALANCE

3. **TransactionAmount** (src/core/transactions/value-objects/TransactionAmount.ts):
   - Branded type: `type TransactionAmount = string & { readonly __brand: unique symbol }`
   - Validation: positive (> 0), max precision 20.2
   - Methods: create(value), toString(amount), toNumber(amount)
   - Error: TRANSACTION_INVALID_AMOUNT

**Input Types**:

**Currencies** (src/core/currencies/types/inputs.ts - NEW):
```typescript
// No input types needed - getSupportedCurrencies takes no params
```

**Currencies** (src/core/currencies/types/outputs.ts - NEW):
```typescript
export type CurrencyData = {
  code: string;
  name: string;
  symbol: string;
  type: string; // 'fiat' | 'crypto'
  isActive: boolean;
  createdAt: Date;
  updatedAt: Date;
};

export type GetCurrenciesResult = {
  currencies: CurrencyData[];
};
```

**Transactions** (src/core/transactions/types/inputs.ts):
```typescript
// Update existing
export type TransferCoinsInput = {
  fromUserId: string;
  toUserId: string;
  amount: number;
  coinType: string; // ADD THIS
};

// Keep existing
export type GetTransactionHistoryInput = {
  userId: string;
  limit?: number;
  offset?: number;
};
```

**Wallets** (src/core/wallets/types/inputs.ts):
```typescript
// Update existing
export type CreateWalletInput = {
  userId: string;
  coinType: string; // ADD THIS
  initialBalance?: number;
};

// Update existing
export type GetWalletInput = {
  userId: string;
  coinType: string; // ADD THIS - get specific wallet
};

// Add new
export type GetUserWalletsInput = {
  userId: string; // Get all wallets for user
};
```

**Output Types**:

**Transactions** (src/core/transactions/types/outputs.ts):
```typescript
export type TransactionData = {
  id: string;
  fromWalletId: string;
  toWalletId: string;
  amount: string;
  coinType: string;
  status: string;
  createdAt: Date;
  updatedAt: Date;
};

export type TransferCoinsResult = {
  transaction: TransactionData;
  fromWalletBalance: string;
  toWalletBalance: string;
};

export type GetTransactionHistoryResult = {
  transactions: TransactionData[];
  total: number;
};
```

**Wallets** (src/core/wallets/types/outputs.ts):
```typescript
// Update existing
export type WalletData = {
  id: string;
  userId: string;
  coinType: string; // ADD THIS
  balance: string;
  createdAt: Date;
  updatedAt: Date;
};

export type CreateWalletResult = WalletData;
export type GetWalletResult = WalletData;
export type GetUserWalletsResult = WalletData[]; // ADD THIS
```

**Error Types**:

**Transactions** (src/core/transactions/types/errors.ts - NEW FILE):
```typescript
export type TransactionError =
  | TransactionInvalidAmountError
  | TransactionInsufficientBalanceError
  | TransactionCoinTypeMismatchError
  | TransactionNotFoundError
  | TransactionWalletNotFoundError;

export type TransactionInvalidAmountError = ErrorBase & {
  code: "TRANSACTION_INVALID_AMOUNT";
};

export type TransactionInsufficientBalanceError = ErrorBase & {
  code: "TRANSACTION_INSUFFICIENT_BALANCE";
};

export type TransactionCoinTypeMismatchError = ErrorBase & {
  code: "TRANSACTION_COIN_TYPE_MISMATCH";
};

export type TransactionNotFoundError = ErrorBase & {
  code: "TRANSACTION_NOT_FOUND";
};

export type TransactionWalletNotFoundError = ErrorBase & {
  code: "TRANSACTION_WALLET_NOT_FOUND";
};
```

**Wallets** (src/core/wallets/types/errors.ts - UPDATE):
```typescript
// Add to existing union
export type WalletError =
  | WalletAlreadyExistsError
  | WalletInsufficientBalanceError
  | WalletInvalidBalanceError
  | WalletNotFoundError
  | WalletInvalidCoinTypeError; // NEW

// Add new error
export type WalletInvalidCoinTypeError = ErrorBase & {
  code: "WALLET_INVALID_COIN_TYPE";
};
```

**Internal Types**:

**Transactions** (src/core/transactions/types/internal.ts):
```typescript
export type ValidatedTransferData = {
  fromUserId: string;
  toUserId: string;
  amount: TransactionAmount;
  coinType: CoinType;
};

export type WalletsForTransfer = {
  fromWallet: WalletWithBalance;
  toWallet: WalletWithBalance;
};

export type WalletWithBalance = {
  id: string;
  userId: string;
  coinType: CoinType;
  balance: WalletBalance;
};
```

**Wallets** (src/core/wallets/types/internal.ts - UPDATE):
```typescript
// Update existing
export type ValidatedWalletCreation = {
  userId: string;
  coinType: CoinType; // ADD THIS
  balance: WalletBalance;
};

// Update existing
export type WalletWithBalance = {
  id: string;
  userId: string;
  coinType: CoinType; // ADD THIS
  balance: WalletBalance;
};
```

### Business Logic

**Workflows**:

**Currencies Domain** (NEW):
1. **getSupportedCurrencies** (src/core/currencies/get-currencies.workflow.ts - NEW):
   ```typescript
   export function getSupportedCurrencies(): Result<GetCurrenciesResult>

   // Steps:
   // 1. findAllActiveCurrencies
   // 2. formatCurrenciesResult
   ```

**Transactions Domain**:
1. **transferCoins** (src/core/transactions/transfer-coins.workflow.ts - NEW):
   ```typescript
   export function transferCoins(input: TransferCoinsInput): Result<TransferCoinsResult>

   // Steps:
   // 1. validateTransferInput (create value objects, validates coin type against DB)
   // 2. findWalletsForTransfer (both wallets)
   // 3. validateSameCoinType
   // 4. checkSufficientBalance
   // 5. executeTransfer (transaction with wallet updates + transaction record)
   // 6. formatTransferResult
   ```

2. **getTransactionHistory** (src/core/transactions/get-history.workflow.ts - NEW):
   ```typescript
   export function getTransactionHistory(input: GetTransactionHistoryInput): Result<GetTransactionHistoryResult>

   // Steps:
   // 1. validateHistoryInput
   // 2. findUserWallets
   // 3. findTransactionsByWallets
   // 4. countTransactions
   // 5. formatHistoryResult
   ```

3. **createWallet** (src/core/wallets/create-wallet.workflow.ts - NEW):
   ```typescript
   export function createWallet(input: CreateWalletInput): Result<CreateWalletResult>

   // Steps:
   // 1. validateWalletCreation (userId, coinType, initialBalance)
   // 2. checkWalletDoesNotExist
   // 3. saveNewWallet
   // 4. formatWalletResult
   ```

4. **getWallet** (src/core/wallets/get-wallet.workflow.ts - NEW):
   ```typescript
   export function getWallet(input: GetWalletInput): Result<GetWalletResult>

   // Steps:
   // 1. validateGetWallet
   // 2. findWalletByUserIdAndCoinType
   // 3. formatWalletResult
   ```

5. **getUserWallets** (src/core/wallets/get-user-wallets.workflow.ts - UPDATE existing):
   ```typescript
   // Already exists - just verify it works with new multi-wallet approach
   ```

**Operations**:

**Currencies**:
- findAllActiveCurrencies (src/core/currencies/get-currencies.operations.ts)
- formatCurrenciesResult

**Transactions**:
- validateTransferInput (src/core/transactions/transfer-coins.operations.ts)
- findWalletsForTransfer (get both wallets)
- validateSameCoinType (ensure both wallets use same coin)
- checkSufficientBalance (compare balance >= amount)
- executeTransfer (DB transaction: deduct + add + create record)
- formatTransferResult
- validateHistoryInput (src/core/transactions/get-history.operations.ts)
- findUserWallets
- findTransactionsByWallets
- countTransactions
- formatHistoryResult

**Wallets**:
- validateWalletCreation (src/core/wallets/create-wallet.operations.ts)
- checkWalletDoesNotExist
- saveNewWallet
- formatWalletResult
- validateGetWallet (src/core/wallets/get-wallet.operations.ts)
- findWalletByUserIdAndCoinType
- formatWalletResult

### Repository

**CurrencyRepository** (src/infrastructure/repositories/drizzle/CurrencyRepository.ts - NEW):
```typescript
export function createCurrencyRepository(dbInstance: typeof db) {
  return {
    findByCode: (code: string): Promise<Currency[]>
    findAllActive: (): Promise<Currency[]>
    findAll: (): Promise<Currency[]>
    create: (data: NewCurrency): Promise<Currency[]>
    update: (code: string, data: Partial<NewCurrency>): Promise<Currency[]>
    deactivate: (code: string): Promise<Currency[]>
    withTransaction: (tx: unknown): CurrencyRepository
  }
}
```

**WalletRepository** (src/infrastructure/repositories/drizzle/WalletRepository.ts - UPDATE):
```typescript
// Add new methods:
- findByUserIdAndCoinType(userId: string, coinType: string): Promise<Wallet[]>
- findAllByUserId(userId: string): Promise<Wallet[]>

// Keep existing:
- create(data: NewWallet): Promise<Wallet[]>
- findById(id: string): Promise<Wallet[]>
- updateBalance(id: string, newBalance: string): Promise<Wallet[]>
- delete(id: string): Promise<Wallet[]>
- withTransaction(tx: unknown): WalletRepository
```

**TransactionRepository** (src/infrastructure/repositories/drizzle/TransactionRepository.ts - UPDATE):
```typescript
// Already has methods from system reminders:
- create(data: NewTransaction): Promise<Transaction[]>
- findById(id: string): Promise<Transaction[]>
- findByWalletId(walletId: string, limit?: number, offset?: number): Promise<Transaction[]>
- countByWalletId(walletId: string): Promise<number>
- findSentByWalletId(walletId: string, limit?: number, offset?: number): Promise<Transaction[]>
- withTransaction(tx: unknown): TransactionRepository

// Just verify all methods exist and work
```

### External Services

None required.

### HTTP Layer

**Routes**:

**Transactions** (src/routes/transactions/routes.ts - NEW):
```typescript
// POST /api/v1/transactions/transfer - Transfer coins between users
// GET /api/v1/transactions/history/:userId - Get transaction history
```

**Currencies** (src/routes/currencies/routes.ts - NEW):
```typescript
// GET /api/v1/currencies - Get all supported currencies
```

**Wallets** (src/routes/wallets/routes.ts - NEW):
```typescript
// POST /api/v1/wallets - Create wallet
// GET /api/v1/wallets/:userId - Get all wallets for user
// GET /api/v1/wallets/:userId/:coinType - Get specific wallet
```

**Handlers**:

**Currencies** (src/routes/currencies/handlers.ts - NEW):
- handleGetSupportedCurrencies

**Transactions** (src/routes/transactions/handlers.ts - NEW):
- handleTransferCoins
- handleGetTransactionHistory

**Wallets** (src/routes/wallets/handlers.ts - NEW):
- handleCreateWallet
- handleGetUserWallets
- handleGetWallet

**Schemas**:

**Currencies** (src/routes/currencies/schemas.ts - NEW):
```typescript
- currencyDataSchema (code, name, symbol, type, isActive)
- getCurrenciesResponseSchema
```

**Transactions** (src/routes/transactions/schemas.ts - NEW):
```typescript
- transferCoinsBodySchema (fromUserId, toUserId, amount, coinType)
- getTransactionHistoryParamsSchema (userId)
- getTransactionHistoryQuerySchema (limit, offset)
- transactionDataSchema
- transferCoinsResponseSchema
- transactionHistoryResponseSchema
```

**Wallets** (src/routes/wallets/schemas.ts - NEW):
```typescript
- createWalletBodySchema (userId, coinType, initialBalance?)
- getUserWalletsParamsSchema (userId)
- getWalletParamsSchema (userId, coinType)
- walletDataSchema
- createWalletResponseSchema
- getUserWalletsResponseSchema
```

### Tests

**Unit Tests**:

1. tests/value-objects/CoinType.test.ts
   - Valid coin types (USD, EUR, BTC, ETH)
   - Invalid coin types
   - Case sensitivity
   - toString conversion

2. tests/value-objects/WalletBalance.test.ts
   - Valid balance creation
   - Negative balance rejection
   - Precision validation
   - add/subtract operations
   - Comparison operations

3. tests/value-objects/TransactionAmount.test.ts
   - Valid amount creation
   - Zero/negative rejection
   - Precision validation
   - toString/toNumber conversion

**OpenAPI Paths**:

**Currencies** (src/openapi/paths/currencies.ts - NEW):
- GET /api/v1/currencies

**Transactions** (src/openapi/paths/transactions.ts - NEW):
- POST /api/v1/transactions/transfer
- GET /api/v1/transactions/history/{userId}

**Wallets** (src/openapi/paths/wallets.ts - NEW):
- POST /api/v1/wallets
- GET /api/v1/wallets/{userId}
- GET /api/v1/wallets/{userId}/{coinType}

### Data Seeding

**Initial Currency Data** (to be added in migration):
```typescript
const initialCurrencies = [
  { code: 'USD', name: 'US Dollar', symbol: '$', type: 'fiat', isActive: true },
  { code: 'EUR', name: 'Euro', symbol: '€', type: 'fiat', isActive: true },
  { code: 'BTC', name: 'Bitcoin', symbol: '₿', type: 'crypto', isActive: true },
  { code: 'ETH', name: 'Ethereum', symbol: 'Ξ', type: 'crypto', isActive: true },
];
```

**Status**: ✅ Complete

---

## Planning

### File Inventory

**NEW FILES** (48 files):

**Database & Repositories**:
1. src/infrastructure/repositories/drizzle/CurrencyRepository.ts
2. src/infrastructure/repositories/drizzle/index.ts (update export)

**Currencies Domain** (8 files):
3. src/core/currencies/get-currencies.workflow.ts
4. src/core/currencies/get-currencies.operations.ts
5. src/core/currencies/types/inputs.ts
6. src/core/currencies/types/outputs.ts
7. src/core/currencies/types/errors.ts
8. src/core/currencies/types/internal.ts
9. src/core/currencies/index.ts (barrel export)
10. src/core/currencies/README.md (optional documentation)

**Transactions Domain** (10 files):
11. src/core/transactions/transfer-coins.workflow.ts
12. src/core/transactions/transfer-coins.operations.ts
13. src/core/transactions/get-history.workflow.ts
14. src/core/transactions/get-history.operations.ts
15. src/core/transactions/types/errors.ts (NEW)
16. src/core/transactions/value-objects/TransactionAmount.ts
17. src/core/transactions/value-objects/CoinType.ts (could also be in wallets)
18. src/core/transactions/index.ts (barrel export)
19. src/core/transactions/README.md (optional documentation)
20. tests/value-objects/TransactionAmount.test.ts

**Wallets Domain** (8 files):
21. src/core/wallets/create-wallet.workflow.ts
22. src/core/wallets/create-wallet.operations.ts
23. src/core/wallets/get-wallet.workflow.ts
24. src/core/wallets/get-wallet.operations.ts
25. src/core/wallets/value-objects/WalletBalance.ts
26. src/core/wallets/value-objects/CoinType.ts (shared with transactions)
27. src/core/wallets/index.ts (UPDATE barrel export)
28. tests/value-objects/WalletBalance.test.ts
29. tests/value-objects/CoinType.test.ts

**HTTP Layer - Currencies** (4 files):
30. src/routes/currencies/routes.ts
31. src/routes/currencies/handlers.ts
32. src/routes/currencies/schemas.ts
33. src/openapi/paths/currencies.ts

**HTTP Layer - Transactions** (4 files):
34. src/routes/transactions/routes.ts
35. src/routes/transactions/handlers.ts
36. src/routes/transactions/schemas.ts
37. src/openapi/paths/transactions.ts

**HTTP Layer - Wallets** (4 files):
38. src/routes/wallets/routes.ts
39. src/routes/wallets/handlers.ts
40. src/routes/wallets/schemas.ts
41. src/openapi/paths/wallets.ts

**Routes Index**:
42. src/routes/index.ts (UPDATE to register new routes)

**OpenAPI**:
43. src/openapi/generate.ts (UPDATE to import new paths)

**Database Migration**:
44. src/db/migrations/XXXX_add_currencies_table.sql (generated)

**MODIFIED FILES** (11 files):

1. **src/db/schema.ts**
   - Add currencies table
   - Update wallets table (add foreign key to currencies)
   - Update transactions table (add foreign key to currencies)

2. **src/core/transactions/types/inputs.ts**
   - Add coinType field to TransferCoinsInput

3. **src/core/transactions/types/outputs.ts**
   - Update TransactionData to include coinType
   - Add TransferCoinsResult, GetTransactionHistoryResult

4. **src/core/transactions/types/internal.ts**
   - Add ValidatedTransferData, WalletsForTransfer types

5. **src/core/wallets/types/inputs.ts**
   - Add coinType to CreateWalletInput
   - Add coinType to GetWalletInput
   - Add GetUserWalletsInput

6. **src/core/wallets/types/outputs.ts**
   - Add coinType to WalletData
   - Add GetUserWalletsResult

7. **src/core/wallets/types/errors.ts**
   - Add WalletInvalidCoinTypeError to union

8. **src/core/wallets/types/internal.ts**
   - Add coinType to ValidatedWalletCreation
   - Add coinType to WalletWithBalance

9. **src/infrastructure/repositories/drizzle/WalletRepository.ts**
   - Add findByUserIdAndCoinType method
   - Add findAllByUserId method
   - Update findByUserId if needed

10. **src/infrastructure/repositories/drizzle/TransactionRepository.ts**
    - Verify all methods exist and work

11. **src/infrastructure/repositories/drizzle/index.ts**
    - Export CurrencyRepository

### Conflict Detection

**Potential Conflicts**:

1. **CoinType Value Object Location**:
   - Decision: Place in `src/core/wallets/value-objects/CoinType.ts`
   - Rationale: Wallets are the primary owner of coin types; transactions import from wallets
   - Import in transactions: `import { CoinType } from "#core/wallets/value-objects/CoinType"`

2. **Existing Wallet Operations**:
   - Files exist: `create-wallet.operations.ts`, `get-wallet.operations.ts`
   - Strategy: Update existing files to include coinType validation
   - Risk: Low - adding fields to existing logic

3. **Database Migration Timing**:
   - Need to handle existing wallets with no coin_type
   - Strategy: Set default 'USD' for existing records before adding foreign key
   - Migration order: currencies table → update existing data → add constraints

4. **Repository Method Naming**:
   - findByUserId exists, need findByUserIdAndCoinType
   - findAllByUserId for multi-wallet support
   - Strategy: Add new methods, keep existing for backward compatibility

### Pre-generation Validation

- [x] **Feasibility check**
  - ✅ All required infrastructure exists (Drizzle ORM, Result system, repository pattern)
  - ✅ No external service dependencies needed
  - ✅ Database supports required data types and constraints
  - ✅ Atomic transactions supported via Drizzle

- [x] **Naming convention check**
  - ✅ Files: kebab-case (transfer-coins.workflow.ts, get-currencies.operations.ts)
  - ✅ Functions: camelCase (transferCoins, getSupportedCurrencies, findByUserIdAndCoinType)
  - ✅ Types: PascalCase (TransferCoinsInput, CurrencyData, WalletInvalidCoinTypeError)
  - ✅ Error codes: DOMAIN_ERROR_TYPE (TRANSACTION_INSUFFICIENT_BALANCE, WALLET_INVALID_COIN_TYPE)

- [x] **FCIS compliance check**
  - ✅ Value objects are pure (no side effects in validation except CoinType which uses command())
  - ✅ Workflows use pipe() for composition
  - ✅ Operations use command() for side effects
  - ✅ Repositories follow factory pattern with withTransaction
  - ✅ Barrel exports hide implementation details
  - ✅ Handlers import only from barrel exports

- [x] **Dependency check**
  - ✅ CoinType depends on CurrencyRepository (infrastructure → core is OK via DI)
  - ✅ Transactions depend on Wallets (via types/value objects)
  - ✅ No circular dependencies detected
  - ✅ All imports follow FCIS boundaries

### Execution Plan

**Specialist Execution Order**:

1. **schema-designer** (Phase: Database)
   - Create currencies table
   - Update wallets and transactions tables with foreign keys
   - Generate migration with data seeding
   - Estimated time: 10 minutes

2. **repository-builder** (Phase: Infrastructure)
   - Create CurrencyRepository
   - Update WalletRepository (add methods)
   - Verify TransactionRepository
   - Update repository index
   - Estimated time: 15 minutes

3. **external-service-builder** (Phase: Infrastructure)
   - SKIP - No external services needed
   - Estimated time: 0 minutes

4. **value-object-creator** (Phase: Core - Value Objects)
   - Create CoinType (wallets domain)
   - Create WalletBalance (wallets domain)
   - Create TransactionAmount (transactions domain)
   - Estimated time: 20 minutes

5. **operations-builder** (Phase: Core - Operations)
   - **Currencies**: get-currencies.operations.ts
   - **Transactions**: transfer-coins.operations.ts, get-history.operations.ts
   - **Wallets**: Update create-wallet.operations.ts, update get-wallet.operations.ts
   - Estimated time: 30 minutes

6. **workflow-composer** (Phase: Core - Workflows)
   - **Currencies**: get-currencies.workflow.ts
   - **Transactions**: transfer-coins.workflow.ts, get-history.workflow.ts
   - **Wallets**: create-wallet.workflow.ts, get-wallet.workflow.ts
   - Update barrel exports (index.ts) for all domains
   - Estimated time: 25 minutes

7. **route-generator** (Phase: HTTP Layer)
   - **Currencies**: routes.ts, handlers.ts, schemas.ts
   - **Transactions**: routes.ts, handlers.ts, schemas.ts
   - **Wallets**: routes.ts, handlers.ts, schemas.ts
   - Update src/routes/index.ts
   - Estimated time: 30 minutes

8. **openapi-registrar** (Phase: Documentation)
   - Create currencies.ts path registrations
   - Create transactions.ts path registrations
   - Create wallets.ts path registrations
   - Update src/openapi/generate.ts imports
   - Estimated time: 20 minutes

9. **test-generator** (Phase: Testing)
   - CoinType.test.ts
   - WalletBalance.test.ts
   - TransactionAmount.test.ts
   - Estimated time: 25 minutes

10. **validator** (Phase: Validation - BLOCKING)
    - Verify barrel export compliance
    - Verify import rules (handlers → barrel only)
    - Verify type conventions
    - Run ESLint
    - Run TypeScript type check
    - Estimated time: 10 minutes

11. **refactoring-agent** (Phase: Alignment - Conditional)
    - Only if validator finds issues
    - Estimated time: 0-20 minutes

**Total Estimated Time**: 175-195 minutes (2.9-3.25 hours)

**Critical Path Dependencies**:
1. schema-designer → repository-builder (repos need schema types)
2. repository-builder → value-object-creator (CoinType needs CurrencyRepository)
3. value-object-creator → operations-builder (operations use value objects)
4. operations-builder → workflow-composer (workflows compose operations)
5. workflow-composer → route-generator (handlers call workflows)
6. route-generator → openapi-registrar (OpenAPI uses schemas)
7. value-object-creator → test-generator (tests test value objects)
8. All → validator (validates everything)

**Parallel Opportunities**: None - must execute sequentially due to dependencies

**Status**: ✅ Complete

---

## Implementation

### Agent Execution Log

#### 1. schema-designer ✅ Complete

**Timestamp**: 2025-11-07 15:45:00

**Files Modified**:
- src/db/schema.ts (added currencies table, updated wallets and transactions)

**Files Created**:
- src/db/migrations/0004_wakeful_bullseye.sql

**Changes**:
1. Added `currencies` table with code (PK), name, symbol, type, isActive, timestamps
2. Inserted initial currency data (USD, EUR, BTC, ETH)
3. Updated `wallets` table:
   - Added `coinType` column with foreign key to currencies.code
   - Removed unique constraint on userId
   - Added unique constraint on (userId, coinType)
   - Added index on coinType
4. Updated `transactions` table:
   - Added `coinType` column with foreign key to currencies.code
   - Added index on coinType

**FCIS Principle Applied**:
"Database schema is an infrastructure concern (Imperative Shell). It defines the data structure separate from business logic (Functional Core)."

**Status**: ✅ Complete

---

#### 2. repository-builder ✅ Complete

#### 3. value-object-creator ✅ Complete

**Files Created**:
- src/core/wallets/value-objects/CoinType.ts (async validation against currencies table)
- src/core/wallets/value-objects/WalletBalance.ts (Decimal.js for precision, arithmetic operations)
- src/core/transactions/value-objects/TransactionAmount.ts (positive validation)

#### 4. operations-builder ✅ Partial

**Files Created**:
- src/core/currencies/get-currencies.operations.ts
- src/core/transactions/transfer-coins.operations.ts
- src/core/wallets/get-wallet.operations.ts (in progress)

**Files Modified**:
- src/core/wallets/create-wallet.operations.ts (added coinType support)

#### 5. workflow-composer ✅ Partial

**Files Created**:
- src/core/currencies/get-currencies.workflow.ts
- src/core/currencies/index.ts (barrel export)
- src/core/wallets/create-wallet.workflow.ts
- src/core/wallets/get-wallet.workflow.ts
- src/core/wallets/index.ts (barrel export)
- src/core/transactions/transfer-coins.workflow.ts
- src/core/transactions/index.ts (barrel export)

#### 6. route-generator ⏳ Started

**Files Created**:
- src/routes/currencies/schemas.ts
- src/routes/currencies/handlers.ts
- src/routes/currencies/routes.ts

**Files Modified**:
- src/routes/index.ts (registered currencies routes)

#### 7. openapi-registrar ⏳ Pending

#### 8. test-generator ⏳ Pending

#### 9. validator ⏳ Pending (30 type errors to resolve)

#### 10. refactoring-agent ⏳ Pending

---

**Status**: ⏳ 60% Complete - Core infrastructure complete, HTTP layer started

---

## Implementation

**Timestamp**: 2025-11-07 15:50:00

**Files Created**:
- src/infrastructure/repositories/drizzle/CurrencyRepository.ts

**Files Modified**:
- src/infrastructure/repositories/drizzle/WalletRepository.ts (added findByUserIdAndCoinType, findAllByUserId)
- src/infrastructure/repositories/drizzle/index.ts (exported all repositories)

**Changes**:
1. Created `CurrencyRepository` with methods:
   - findByCode
   - findAllActive
   - findAll
   - create
   - update
   - deactivate
   - withTransaction

2. Updated `WalletRepository`:
   - Added `findByUserIdAndCoinType(userId, coinType)` method
   - Added `findAllByUserId(userId)` method for multi-wallet support
   - Kept `findByUserId` for backward compatibility (deprecated)

3. Updated repository barrel export to include all repositories

**FCIS Principle Applied**:
"Repository is Imperative Shell - provides data access using factory functions for dependency injection and testability."

**Status**: ✅ Complete

---

**Status**: ⏳ In Progress

---

## Iteration Log
[Iteration history will be tracked here]

---

## Summary
[Final summary will be added here]
