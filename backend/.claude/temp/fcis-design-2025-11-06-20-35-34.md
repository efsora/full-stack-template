# FCIS Implementation Design

**Task**: Implement a wallet for users and transaction feature for users
**Domain**: wallets (new), transactions (new)
**Created**: 2025-11-06-20-35-34
**Status**: planning

---

## Analysis

**Primary Domain**: wallets (new domain)
**Secondary Domain**: transactions (new domain)
**Existing Domain**: users (will be referenced)

**Pattern Analysis**:
- **Naming conventions**:
  - Files: kebab-case (`create-user.workflow.ts`, `find.operations.ts`)
  - Functions: camelCase (`createUser`, `getUserById`)
  - Types: PascalCase (`CreateUserInput`, `UserData`)
  - Error codes: SCREAMING_SNAKE_CASE with DOMAIN_prefix (`USER_NOT_FOUND`)
- **File structure**:
  - Workflows: one file per main workflow
  - Operations: grouped by feature
  - Types in types/ directory (inputs, outputs, errors, internal)
  - Value objects in value-objects/ directory
  - Barrel export at index.ts
- **Common workflows**: CRUD patterns (create, get/find)
- **Error codes**: Domain-prefixed (USER_*, WALLET_*, TRANSACTION_*)
- **Value objects**: Email, Password (branded types with validation)

**Required Components**:
- **Database**: wallets table, transactions table
- **Workflows**: createWallet, getWallet, createTransaction, processTransaction, listTransactions
- **Operations**: wallet CRUD, transaction CRUD, balance management
- **Value Objects**: Amount, Currency, TransactionType, TransactionStatus
- **External Services**: None initially
- **Routes**: /wallets, /transactions endpoints
- **Types**: Input/Output/Error types for both domains

**Status**: ✅ Complete

---

## Design

### Database Schema

**Wallets Table** - stores user wallet with balance:
- id (uuid, PK)
- user_id (uuid, FK → users.id, unique)
- balance (numeric 20,8)
- currency (text, default USD)
- created_at, updated_at (timestamps)

**Transactions Table** - records all wallet transactions:
- id (uuid, PK)
- wallet_id (uuid, FK → wallets.id)
- type (text: CREDIT/DEBIT)
- amount (numeric 20,8)
- currency (text)
- description (text, nullable)
- status (text: PENDING/COMPLETED/FAILED/CANCELLED)
- reference_id (text, nullable - external ref)
- metadata (jsonb, nullable)
- created_at, updated_at (timestamps)

**Indexes**:
- wallets: user_id (unique)
- transactions: wallet_id, reference_id, created_at DESC

### Type System

**Value Objects**: Amount, Currency, TransactionType, TransactionStatus

**Wallets Inputs**: CreateWalletInput, UpdateWalletBalanceInput
**Wallets Outputs**: WalletData, CreateWalletResult
**Wallets Errors**: WALLET_NOT_FOUND, WALLET_ALREADY_EXISTS, WALLET_INSUFFICIENT_BALANCE, WALLET_INVALID_CURRENCY

**Transactions Inputs**: CreateTransactionInput, UpdateTransactionStatusInput, ListTransactionsInput
**Transactions Outputs**: TransactionData, CreateTransactionResult, ListTransactionsResult
**Transactions Errors**: TRANSACTION_NOT_FOUND, TRANSACTION_INVALID_AMOUNT, TRANSACTION_FAILED, TRANSACTION_INVALID_STATUS

### Business Logic

**Wallets Workflows**:
- createWallet: validate → check user exists → check no wallet exists → save wallet
- getWalletById: validate ID → find wallet → format
- getWalletByUserId: validate user ID → find wallet → format

**Transactions Workflows**:
- createTransaction: validate → check wallet → check balance (if DEBIT) → save transaction
- processTransaction: find transaction → update wallet balance → mark completed (atomic)
- listTransactionsByWallet: validate → fetch + count → format with pagination

**Operations**: Validation, database CRUD, balance calculations (all using command() for side effects)

### Repository

**WalletRepository**: findById, findByUserId, create, updateBalance, withTransaction
**TransactionRepository**: findById, findByWalletId, findByReferenceId, create, updateStatus, count, withTransaction

### External Services
None initially (future: payment gateway)

### HTTP Layer

**Wallets Routes**:
- POST /api/v1/wallets (create)
- GET /api/v1/wallets/:id (get by ID)
- GET /api/v1/wallets/user/:userId (get by user)

**Transactions Routes**:
- POST /api/v1/transactions (create)
- POST /api/v1/transactions/:id/process (process)
- GET /api/v1/transactions/:id (get by ID)
- GET /api/v1/transactions/wallet/:walletId (list)
- PATCH /api/v1/transactions/:id/status (update status)

### Tests
- Amount.test.ts, Currency.test.ts, TransactionType.test.ts, TransactionStatus.test.ts

**Status**: ✅ Complete

---

## Planning

### File Inventory

**New Files (Wallets - 12)**:
- Core types (4): inputs.ts, outputs.ts, errors.ts, internal.ts
- Value objects (2): Amount.ts, Currency.ts
- Operations (3): create-wallet.operations.ts, find-wallet.operations.ts, update-balance.operations.ts
- Workflows (2): create-wallet.workflow.ts, get-wallet.workflow.ts
- Barrel (1): index.ts

**New Files (Transactions - 13)**:
- Core types (4): inputs.ts, outputs.ts, errors.ts, internal.ts
- Value objects (2): TransactionType.ts, TransactionStatus.ts
- Operations (3): create-transaction.operations.ts, process-transaction.operations.ts, find-transaction.operations.ts
- Workflows (3): create-transaction.workflow.ts, process-transaction.workflow.ts, list-transactions.workflow.ts
- Barrel (1): index.ts

**New Files (Infrastructure - 2)**:
- WalletRepository.ts, TransactionRepository.ts

**New Files (HTTP - 6)**:
- Wallets (3): schemas.ts, handlers.ts, routes.ts
- Transactions (3): schemas.ts, handlers.ts, routes.ts

**New Files (OpenAPI - 2)**:
- wallets.ts, transactions.ts

**New Files (Tests - 4)**:
- Amount.test.ts, Currency.test.ts, TransactionType.test.ts, TransactionStatus.test.ts

**Modified Files (4)**:
- src/db/schema.ts (ADD tables)
- src/infrastructure/repositories/drizzle/index.ts (ADD exports)
- src/routes/index.ts (ADD routes)
- src/openapi/generate.ts (ADD imports)

**New Migrations (1)**:
- XXXX_add_wallets_and_transactions.sql

**Total**: 39 new + 4 modified + 1 migration = **44 files**

### Conflict Detection
✅ No conflicts - entirely new domains

### Pre-generation Validation
✅ Feasibility: All components implementable
✅ Naming: Follows conventions
✅ Compliance: Uses pipe(), command(), barrel exports
✅ Dependencies: Only requires existing users table

### Execution Plan

**Agent Sequence** (11 agents):
1. schema-designer → tables + migration
2. repository-builder → WalletRepository, TransactionRepository
3. external-service-builder → SKIP
4. value-object-creator → Amount, Currency, TransactionType, TransactionStatus
5. operations-builder → wallet + transaction operations
6. workflow-composer → wallet + transaction workflows
7. route-generator → wallet + transaction routes
8. openapi-registrar → API documentation
9. test-generator → value object tests
10. validator → compliance checks
11. refactoring-agent → SKIP

**Estimated Time**: 10-15 minutes

**Status**: ✅ Complete - Ready for Implementation

---

## Summary

### What Will Be Built
Two new domains for digital wallet functionality:
- **Wallets**: User balance management in specified currency
- **Transactions**: CREDIT/DEBIT operations with status tracking

### Key Features
- One wallet per user (enforced at DB level)
- Atomic transaction processing (updates wallet + marks completed)
- Transaction status lifecycle (PENDING → COMPLETED/FAILED/CANCELLED)
- External reference support (link to orders, payments, etc.)
- Pagination for transaction lists
- Balance validation (prevent overdrafts)

### Architecture
- **44 total files**: 39 new, 4 modified, 1 migration
- **2 new domains**: wallets, transactions (full FCIS structure)
- **4 value objects**: Type-safe primitives
- **2 repositories**: Factory pattern with transaction support
- **8 API endpoints**: RESTful wallet & transaction operations
- **4 unit tests**: Value object validation

### FCIS Compliance
✅ Functional Core (workflows, operations, value objects)
✅ Imperative Shell (repositories, routes, handlers)
✅ Railway-Oriented Programming (pipe composition)
✅ Command Pattern (side effect wrapping)
✅ Barrel Exports (public API only)
✅ Type Safety (branded types, strict typing)

### Next Steps
Since this is **plan-only mode**, review the design and when ready run:
```bash
/fcis:create "Implement a wallet for users and transaction feature for users"
```

To proceed with full implementation of all 44 files.
