/**
 * Error Type System for Effect-based Error Handling
 *
 * This module defines the base type system for typed errors in the Effect system.
 * All errors extend ErrorBase. Domain-specific errors are defined in their respective modules.
 *
 * Design Principles:
 * - Domain-specific error codes (USER_NOT_FOUND, POST_FORBIDDEN, etc.) instead of generic codes
 * - Minimal metadata in ErrorBase (message, timestamp, userId, context)
 * - Error codes encode the domain and error type (no resourceType needed)
 * - Compile-time type safety for all error fields
 * - Domain-specific error types unified in AppError union
 */

import type { UserError } from "#core/users/types/errors";

/**
 * Global application error union.
 * Combines all domain-specific errors into a single union type.
 * This type is used throughout the Effect system for type-safe error handling.
 *
 * Generic errors (infrastructure-level, no domain context):
 * - CommandExecutionError: Effect execution failures
 * - InternalError: Unexpected server errors
 * - UnauthorizedError: Authentication required
 *
 * Domain errors:
 * - UserError: User-related errors (USER_NOT_FOUND, USER_FORBIDDEN, etc.)
 *
 * To add new domains, import the domain error type and add to this union:
 * @example
 * ```typescript
 * import type { PostError } from "#core/posts/types/errors";
 * export type AppError = ... | UserError | PostError;
 * ```
 */
export type AppError =
  | CommandExecutionError
  | InternalError
  | UnauthorizedError
  | UserError;

/**
 * Command execution error - effect execution failure.
 * Used when a Command throws an exception during execution.
 *
 * @property code - Always "COMMAND_EXECUTION_ERROR"
 *
 * @example
 * ```typescript
 * {
 *   code: "COMMAND_EXECUTION_ERROR",
 *   message: "Database query failed",
 *   timestamp: "2025-10-19T10:30:00.000Z",
 *   context: { operation: "findUserById", error: "Connection timeout" }
 * }
 * ```
 */
export type CommandExecutionError = ErrorBase & {
  code: "COMMAND_EXECUTION_ERROR";
};

/**
 * Base error structure containing common metadata fields.
 * All domain-specific errors extend this base.
 *
 * @property message - Human-readable error message
 * @property timestamp - ISO 8601 timestamp when error occurred (auto-generated by fail())
 * @property userId - Optional ID of user who triggered the error (for audit/tracking)
 * @property context - Optional free-form metadata (ip, userAgent, requestId, etc.)
 */
export type ErrorBase = {
  context?: Record<string, unknown>;
  message: string;
  timestamp?: string;
  userId?: number | string;
};

/**
 * Generic error codes for infrastructure-level errors.
 * Domain-specific errors should use their own codes (e.g., USER_NOT_FOUND, POST_FORBIDDEN).
 */
export type ErrorCode =
  | "COMMAND_EXECUTION_ERROR" // Effect execution failure
  | "INTERNAL_ERROR" // Unexpected server error
  | "UNAUTHORIZED"; // User not authenticated

/**
 * Internal error - unexpected server error.
 * Used for unhandled exceptions and unexpected error conditions.
 *
 * @property code - Always "INTERNAL_ERROR"
 *
 * @example
 * ```typescript
 * {
 *   code: "INTERNAL_ERROR",
 *   message: "Database connection failed",
 *   timestamp: "2025-10-19T10:30:00.000Z"
 * }
 * ```
 */
export type InternalError = ErrorBase & {
  code: "INTERNAL_ERROR";
};

/**
 * Unauthorized error - user not authenticated.
 * Used when authentication is required but not provided or invalid.
 *
 * @property code - Always "UNAUTHORIZED"
 *
 * @example
 * ```typescript
 * {
 *   code: "UNAUTHORIZED",
 *   message: "Invalid email or password",
 *   timestamp: "2025-10-19T10:30:00.000Z"
 * }
 * ```
 */
export type UnauthorizedError = ErrorBase & {
  code: "UNAUTHORIZED";
};

/**
 * Type guard to check if an error is a command execution error.
 */
export function isCommandExecutionError(
  error: AppError,
): error is CommandExecutionError {
  return error.code === "COMMAND_EXECUTION_ERROR";
}

/**
 * Type guard to check if an error is an internal error.
 */
export function isInternalError(error: AppError): error is InternalError {
  return error.code === "INTERNAL_ERROR";
}

/**
 * Type guard to check if an error is an unauthorized error.
 */
export function isUnauthorizedError(
  error: AppError,
): error is UnauthorizedError {
  return error.code === "UNAUTHORIZED";
}
