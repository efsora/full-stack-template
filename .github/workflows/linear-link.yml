name: Linear Linker
on:
  pull_request:
    types: [opened, edited, synchronize]

permissions:
  contents: read
  pull-requests: write

jobs:
  add-linear-link:
    runs-on: ubuntu-latest
    if: ${{ github.event.pull_request.head.repo.fork == false }}
    steps:
      - name: Add Linear issue link to PR body if missing
        uses: actions/github-script@v7
        env:
          LINEAR_WORKSPACE_SLUG: efsora
        with:
          script: |
            const pr = context.payload.pull_request;
            const headRef = pr.head.ref;
            const title = pr.title || '';
            const body = pr.body || '';
            const m = (headRef.match(/([A-Z]+-\d+)/) || title.match(/([A-Z]+-\d+)/));
            if (!m) {
              core.info('No issue key found in branch or title. Skipping.');
              return;
            }
            const issueKey = m[1];
            const linearUrl = `https://linear.app/${process.env.LINEAR_WORKSPACE_SLUG}/issue/${issueKey}`;

            if (body.includes(linearUrl)) {
              core.info('Linear link already present. Skipping.');
              return;
            }

            const newBody = (body ? body + '\n\n' : '') + `**Linear Issue:** [${issueKey}](${linearUrl})`;

            await github.rest.pulls.update({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: pr.number,
              body: newBody
            });
            core.info(`Added Linear link for ${issueKey}`);
